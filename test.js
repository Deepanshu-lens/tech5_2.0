class t extends HTMLElement{t=null;i=null;o=null;h="";pc=null;l=WebSocket.CLOSED;p=WebSocket.CLOSED;u="";m=5e3;v=5e4;g=["avc1.640029","avc1.64002A","avc1.640033"];k="webrtc";media="video";background=!0;S=0;T=!1;W={O:[{I:"stun:3.145.176.80:3478"}],C:"balanced",R:"require"};$=0;D=5e3;N=5e4;P=null;onmessage={};constructor(){super()}M(t){if(this.o&&this.i)switch(t){case"LOADING":this.i.style.display="block",this.o&&(this.o.style.display="none");break;case"LOADED":this.i.style.display="none",this.o&&(this.o.style.display="block");break;case"ERROR":this.i.style.display="block",this.i.className=this.i.className.replace("bg-gray-300","bg-red-300")}}A(){if(this.h=this.getAttribute("data-url"),this.D&&(clearTimeout(this.D),this.D=0),this.o){const t=this.o.seekable;t.length>0&&(this.o.currentTime=t.end(t.length-1)),this.play()}else this.L();this.onconnect()}U(){this.background||this.D||this.l===WebSocket.CLOSED&&this.p===WebSocket.CLOSED||(this.D=window.setTimeout((()=>{this.N&&(clearTimeout(this.N),this.N=0),this.D=0,this.ondisconnect()}),this.m))}L(){console.log("stream.oninit"),this.o=document.createElement("video"),this.o.controls=!1,this.o.playsInline=!0,this.o.preload="auto",this.o.style.display="block",this.o.className="rounded-lg object-fit ",this.i=document.createElement("div"),this.i.className="absolute bg-gray-300 animate-pulse object-fit h-full rounded-lg",this.i.style.width="100%",this.i.style.height="100%",this.appendChild(this.i),this.appendChild(this.o);const t=window.navigator.userAgent.match(/Version\/(\d+).+Safari/);if(t){const i=t&&t[1]?t[1]<"13"?"mp4a.40.2":t[1]<"14"?"flac":"opus":"opus";this.g.splice(this.g.indexOf(i))}this.background||("hidden"in document&&this.T&&document.addEventListener("visibilitychange",(()=>{document.hidden?this.U():this.isConnected&&this.A()})),"IntersectionObserver"in window&&this.S&&new IntersectionObserver((t=>{t.forEach((t=>{t.isIntersecting?this.isConnected&&this.A():this.U()}))}),{threshold:this.S}).observe(this))}onconnect(){return console.log("stream.onconnect, wsURL: ",this.h),!(!this.isConnected||!this.h||this.t||this.pc)&&(this.l=WebSocket.CONNECTING,this.$=Date.now(),this.t=new WebSocket(this.h),this.t.binaryType="arraybuffer",this.t.addEventListener("open",(()=>this.onopen())),this.t.addEventListener("close",(()=>this.onclose())),!0)}onopen(){console.log("stream.onopen"),this.l=WebSocket.OPEN,this.t&&this.t.addEventListener("message",(t=>{if("string"==typeof t.data){const i=JSON.parse(t.data);i.value;for(const t in this.onmessage)this.onmessage[t]&&this.onmessage[t](i)}else this.P&&this.P(t.data)})),this.P=null,this.onmessage={};const t=[];return"RTCPeerConnection"in window&&(t.push("webrtc"),this._()),t}onclose(){if(console.log("stream.onclose"),this.l===WebSocket.CLOSED)return!1;this.l=WebSocket.CONNECTING,this.t=null;const t=Math.max(this.v-(Date.now()-this.$),0);return this.N=window.setTimeout((()=>{this.N=0,this.onconnect()}),t),!0}ondisconnect(){console.log("stream.ondisconnect"),this.l=WebSocket.CLOSED,this.t&&(this.t.close(),this.t=null),this.p=WebSocket.CLOSED,this.pc&&(this.pc.getSenders().forEach((t=>{t.track&&t.track.stop()})),this.pc.close(),this.pc=null),this.o&&(this.o.src=""),this.o&&(this.o.srcObject=null)}play(){this.o&&this.o.play().catch((()=>{this.o&&!this.o.muted&&(this.o.muted=!0,this.o.play().catch((t=>{console.warn(t)})))}))}send(t){this.t&&this.t.send(JSON.stringify(t))}H(t){return this.g.filter((t=>this.media.indexOf(t.indexOf("vc1")>0?"video":"audio")>=0)).filter((i=>t(`video/mp4; codecs="${i}"`))).join()}_(){const t=new RTCPeerConnection(this.W);t.addEventListener("icecandidate",(t=>{if(t.candidate&&this.k.indexOf("webrtc/tcp")>=0&&"udp"===t.candidate.protocol)return;const i=t.candidate?t.candidate.toJSON().candidate:"";this.send({type:"webrtc/candidate",value:i})})),t.addEventListener("connectionstatechange",(()=>{if("connected"===t.connectionState){const i=t.getReceivers().map((t=>t.track)),e=document.createElement("video");e.addEventListener("loadeddata",(()=>this.j(e)),{once:!0}),e.srcObject=new MediaStream(i)}else("failed"===t.connectionState||"disconnected"===t.connectionState)&&(t.close(),this.p=WebSocket.CLOSED,this.pc=null,this.M("ERROR"),this.onconnect())})),this.onmessage.F=i=>{switch(i.type){case"webrtc/candidate":if(this.k.indexOf("webrtc/tcp")>=0&&i.value.indexOf(" udp ")>0)return void console.log("WHAT AM I DOING?!",i.value);const e=`candidate:${i.value.G} 1 udp ${i.value.J} ${i.value.V} ${i.value.q} typ srflx raddr 0.0.0.0 rport ${i.value.q}`;t.addIceCandidate({candidate:e,sdpMid:"0"}).catch((t=>{console.warn(t)}));break;case"webrtc/answer":const s=`v=0\r\no=- ${i.value.B[0][0]} ${i.value.B[0][1]} IN IP4 0.0.0.0\r\ns=-\r\nt=0 0\r\na=msid-semantic:WMS*\r\na=fingerprint:sha-256 ${i.value.K[0][0]}\r\na=extmap-allow-mixed\r\na=group:BUNDLE 0\r\nm=video 9 UDP/TLS/RTP/SAVPF 102 106 112\r\nc=IN IP4 0.0.0.0\r\na=setup:active\r\na=mid:0\r\na=ice-ufrag:${i.value.X[0]}\r\na=ice-pwd:${i.value.Y[0]}\r\na=rtcp-mux\r\na=rtcp-rsize\r\na=rtpmap:102 H264/90000\r\na=fmtp:102 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42001f\r\na=rtcp-fb:102 goog-remb \r\na=rtcp-fb:102 transport-cc \r\na=rtcp-fb:102 ccm fir\r\na=rtcp-fb:102 nack \r\na=rtcp-fb:102 nack pli\r\na=rtpmap:106 H264/90000\r\na=fmtp:106 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f\r\na=rtcp-fb:106 goog-remb \r\na=rtcp-fb:106 transport-cc \r\na=rtcp-fb:106 ccm fir\r\na=rtcp-fb:106 nack \r\na=rtcp-fb:106 nack pli\r\na=rtpmap:112 H264/90000\r\na=fmtp:112 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=64001f\r\na=rtcp-fb:112 goog-remb \r\na=rtcp-fb:112 transport-cc \r\na=rtcp-fb:112 ccm fir\r\na=rtcp-fb:112 nack \r\na=rtcp-fb:112 nack pli\r\na=extmap:4 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01\r\na=ssrc:${i.value.Z[0]} cname:go2rtc\r\na=ssrc:${i.value.Z[0]} msid:go2rtc go2rtc-video\r\na=ssrc:${i.value.Z[0]} mslabel:go2rtc\r\na=ssrc:${i.value.Z[0]} label:go2rtc-video\r\na=msid:go2rtc go2rtc-video\r\na=sendonly\r\n`;t.setRemoteDescription({type:"answer",sdp:s}).catch((t=>{console.warn(t)}));break;case"error":if(i.value.indexOf("webrtc/offer")<0)return;t.close(),this.M("ERROR")}},this.createOffer(t).then((t=>{var i={};const e={B:/o=- (\d+) (\d+) IN IP4/,K:/fingerprint:sha-256 ([A-F0-9:]+)/,X:/ice-ufrag:(\S+)/,Y:/ice-pwd:(\S+)/,Z:/ssrc:(\d+)/};for(const s in e){const n=e[s],c=t.sdp.match(n);c&&(i[s]=c.slice(1))}this.send({type:"webrtc/offer",tt:i})})),this.p=WebSocket.CONNECTING,this.pc=t}async createOffer(t){try{this.media.indexOf("microphone")>=0&&(await navigator.mediaDevices.getUserMedia({it:!0})).getTracks().forEach((i=>{t.addTransceiver(i,{direction:"sendonly"})}))}catch(t){console.warn(t)}for(const i of["video","audio"])this.media.indexOf(i)>=0&&t.addTransceiver(i,{direction:"recvonly"});const i=await t.createOffer();return await t.setLocalDescription(i),i}j(t){if(this.pc){let i=0,e=0;const s=t.srcObject;s.getVideoTracks().length>0&&(i+=544),s.getAudioTracks().length>0&&(i+=258),this.u.indexOf("hvc1.")>=0&&(e+=560),this.u.indexOf("avc1.")>=0&&(e+=528),this.u.indexOf("mp4a.")>=0&&(e+=257),i>=e?(this.o&&(this.o.srcObject=s),this.M("LOADED"),this.play(),this.p=WebSocket.OPEN,this.l=WebSocket.CLOSED,this.t&&(this.t.close(),this.t=null)):(this.p=WebSocket.CLOSED,this.pc&&(this.pc.close(),this.pc=null))}t.srcObject=null}}typeof window<"u"&&customElements.define("lens-view-stream-tile-custom",t);